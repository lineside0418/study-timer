<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Focus Timer</title>
    <link rel="icon" href="./icons/icon.png" type="image/x-icon">
    <link rel="shortcut icon" href="./icons/icon.png" type="image/x-icon">
    <link rel="apple-touch-icon" href="./icons/icon-192x192.png" sizes="192x192">
    <link rel="icon" href="./icons/icon-192x192.png" sizes="192x192" type="image/png">
    <link rel="manifest" href="manifest.json">
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;700&family=Noto+Sans+JP:wght@400;500;700&display=swap" rel="stylesheet">
    <link href="https://cdn.jsdelivr.net/npm/remixicon@4.2.0/fonts/remixicon.css" rel="stylesheet" />
    <style>
        /* --- 基本設定 --- */
        :root {
            --text-color-dark: #ffffff;
            --text-color-light: #000000;
            --bg-color-dark: #000000;
            --bg-color-light: #f0f0f0;
            --progress-bg-dark: rgba(255, 255, 255, 0.1);
            --progress-bg-light: rgba(0, 0, 0, 0.08);
            --font-family-en: 'Inter', sans-serif;
            --font-family-ja: 'Noto Sans JP', sans-serif;
            --digit-height: 1.2em;
            --padding-base: 20px;
        }

        *, *::before, *::after { box-sizing: border-box; }

        body {
            margin: 0; padding: var(--padding-base);
            min-height: 100svh; width: 100vw;
            overflow: hidden;
            font-family: var(--font-family-ja);
            color: var(--text-color-dark);
            background-color: var(--bg-color-dark);
            transition: background-color 0.3s, color 0.3s;
            display: grid;
            grid-template-columns: auto 1fr auto;
            grid-template-rows: auto 1fr auto;
            /* ★音楽プレイヤーを中央に持っていくためレイアウトをシンプルに */
            grid-template-areas:
                "top-left . top-right"
                "center center center"
                "bottom-left . bottom-right";
        }
        body.light-mode { color: var(--text-color-light); background-color: var(--bg-color-light); }

        button { background: none; border: none; color: inherit; cursor: pointer; transition: opacity 0.2s; padding: 0; }
        button:hover { opacity: 0.7; }
        
        /* --- スプラッシュスクリーン --- */
        #splash-screen {
            position: fixed; top: 0; left: 0;
            width: 100%; height: 100%;
            background: var(--bg-color-dark);
            z-index: 9999;
            display: grid; place-items: center;
            opacity: 1;
        }
        #splash-screen.hidden { display: none; }
        .splash-clock-wrapper { display: flex; flex-direction: column; align-items: center; gap: 20px; }
        .splash-clock {
            width: clamp(100px, 20vw, 150px); height: clamp(100px, 20vw, 150px);
            border: 4px solid var(--text-color-dark); border-radius: 50%;
            position: relative;
        }
        .splash-clock::before { content: ''; position: absolute; top: 50%; left: 50%; width: 8px; height: 8px; background: var(--text-color-dark); border-radius: 50%; transform: translate(-50%, -50%); }
        .clock-hand { position: absolute; bottom: 50%; left: 50%; background: var(--text-color-dark); transform-origin: bottom center; }
        .minute-hand { width: 4px; height: 45%; animation: minute-spin 2s cubic-bezier(0.68, -0.55, 0.27, 1.55) forwards; }
        .hour-hand { width: 6px; height: 30%; border-radius: 2px; animation: hour-spin 2.2s cubic-bezier(0.68, -0.55, 0.27, 1.55) forwards; }
        .splash-title { font-family: var(--font-family-en); font-size: clamp(1.5rem, 5vw, 2.5rem); font-weight: 500; letter-spacing: 2px; opacity: 0; animation: text-fade-in 1s ease forwards 1.8s; }
        @keyframes minute-spin { from { transform: translateX(-50%) rotate(0deg); } to { transform: translateX(-50%) rotate(1440deg); } }
        @keyframes hour-spin { from { transform: translateX(-50%) rotate(0deg); } to { transform: translateX(-50%) rotate(360deg); } }
        @keyframes text-fade-in { to { opacity: 1; } }
        @keyframes splash-fade-out { to { opacity: 0; visibility: hidden; } }

        /* --- レイアウト要素 --- */
        #clock { grid-area: top-left; align-self: start; font-family: var(--font-family-en); font-size: clamp(1rem, 3vw, 1.5rem); font-weight: 500; }
        .top-right-controls { grid-area: top-right; align-self: start; }
        /* ★アイコンサイズ修正 (スマホ対応) */
        .top-right-controls button { font-size: clamp(1.5rem, 5vw, 2rem); }

        .timer-container { grid-area: center; display: grid; place-items: center; height: 100%; overflow-y: auto; padding: 10px 0; }
        .timer-wrapper { display: flex; flex-direction: column; align-items: center; gap: clamp(10px, 2vh, 15px); }

        .bottom-left-controls, .bottom-right-controls { align-self: end; position: relative; }
        .bottom-left-controls { grid-area: bottom-left; }
        .bottom-right-controls { grid-area: bottom-right; }
        
        /* --- ハンバーガーメニュー --- */
        /* ★アイコンサイズ修正 (スマホ対応) */
        #menu-toggle { font-size: clamp(1.8rem, 6vw, 2.2rem); padding: 5px; z-index: 1001; }
        #menu-panel {
            position: absolute; bottom: calc(100% + 10px); left: 0;
            background-color: var(--progress-bg-dark);
            padding: 15px; border-radius: 12px;
            display: flex; flex-direction: column; gap: 10px;
            z-index: 1000; opacity: 0; visibility: hidden;
            transform: translateY(10px);
            transition: opacity 0.2s ease, visibility 0.2s ease, transform 0.2s ease;
            backdrop-filter: blur(10px);
            max-height: 50vh; overflow-y: auto;
        }
        #menu-panel.show { opacity: 1; visibility: visible; transform: translateY(0); }
        body.light-mode #menu-panel { background-color: rgba(255, 255, 255, 0.7); }
        .menu-item, .ambient-item { display: flex; align-items: center; justify-content: space-between; gap: 15px; padding: 5px; }
        .menu-label { font-size: clamp(0.9rem, 2.5vw, 1rem); white-space: nowrap; display: flex; align-items: center; gap: 8px; }
        .menu-label i { font-size: 1.2em; }
        .ambient-controls { display: flex; align-items: center; gap: 12px; }
        .volume-slider { -webkit-appearance: none; appearance: none; width: 80px; height: 5px; background: rgba(255, 255, 255, 0.3); border-radius: 5px; outline: none; transition: opacity 0.2s; }
        body.light-mode .volume-slider { background: rgba(0, 0, 0, 0.2); }
        .volume-slider::-webkit-slider-thumb { -webkit-appearance: none; appearance: none; width: 15px; height: 15px; background: #fff; border-radius: 50%; cursor: pointer; }
        body.light-mode .volume-slider::-webkit-slider-thumb { background: #333; }
        .switch { position: relative; display: inline-block; width: 44px; height: 24px; }
        .switch input { opacity: 0; width: 0; height: 0; }
        .slider { position: absolute; cursor: pointer; top: 0; left: 0; right: 0; bottom: 0; background-color: rgba(255, 255, 255, 0.2); transition: .4s; border-radius: 24px; }
        body.light-mode .slider { background-color: rgba(0, 0, 0, 0.2); }
        .slider:before { position: absolute; content: ""; height: 18px; width: 18px; left: 3px; bottom: 3px; background-color: white; transition: .4s; border-radius: 50%; }
        body.light-mode .slider:before { background-color: #333; }
        input:checked + .slider { background-color: #3cb371; }
        input:checked + .slider:before { transform: translateX(20px); }

        /* --- 右下アイコン --- */
        /* ★アイコンサイズ修正 (スマホ対応) */
        #total-study-time-toggle { font-size: clamp(1.5rem, 5vw, 2rem); padding: 5px; }
        #total-study-time-display { position: absolute; bottom: calc(100% + 10px); right: 0; background-color: var(--progress-bg-dark); padding: 8px 12px; border-radius: 8px; font-size: clamp(0.8rem, 2.5vw, 1rem); font-family: var(--font-family-en); font-weight: 500; white-space: nowrap; opacity: 0; visibility: hidden; transform: translateY(10px); transition: all 0.2s ease; }
        #total-study-time-display.show { opacity: 1; visibility: visible; transform: translateY(0); }
        body.light-mode #total-study-time-display { background-color: var(--progress-bg-light); }

        /* --- タイマー表示 --- */
        .timer-display-wrapper { position: relative; padding: clamp(5px, 2vw, 10px) clamp(15px, 5vw, 30px); border-radius: 10px; }
        .timer-display-wrapper::before { content: ''; position: absolute; top: 0; left: 0; height: 100%; width: 100%; background-color: var(--progress-bg-dark); border-radius: 10px; transition: background-color 0.3s; z-index: -1; }
        body.light-mode .timer-display-wrapper::before { background-color: var(--progress-bg-light); }
        #timer-display { font-size: clamp(3rem, 10vw, 7rem); font-weight: 700; font-family: var(--font-family-en); z-index: 1; display: flex; align-items: center; height: var(--digit-height); overflow: hidden; }
        #timer-display .digit-container { position: relative; display: inline-block; overflow: hidden; height: var(--digit-height); line-height: var(--digit-height); width: 0.6em; text-align: center; }
        #timer-display .digit-strip { position: absolute; top: 0; left: 0; width: 100%; transition: transform 0.4s cubic-bezier(0.64, 0.04, 0.35, 1); padding-top: var(--digit-height); padding-bottom: var(--digit-height); transform: translateY(calc(-1 * (1 + 0) * var(--digit-height))); }
        #timer-display .digit-strip > div { height: var(--digit-height); display: flex; align-items: center; justify-content: center; }
        #timer-display .colon { display: inline-block; margin: 0 0.1em; height: var(--digit-height); line-height: var(--digit-height); }
        #timer-display.resting { color: #3cb371; }

        /* --- タイマー操作ボタン --- */
        .timer-controls { gap: clamp(10px, 3vw, 20px); display: flex; justify-content: center; }
        /* ★アイコンサイズ修正 (スマホ対応) */
        .timer-controls button { font-size: clamp(2.2rem, 8vw, 3rem); }
        .time-settings { transition: opacity 0.4s ease, visibility 0.4s ease, max-height 0.4s ease-in-out, margin 0.4s ease; max-height: 100px; overflow: hidden; display: flex; align-items: center; gap: clamp(8px, 2vw, 15px); margin-top: clamp(5px, 2vh, 10px); font-size: clamp(0.8rem, 2vw, 0.9rem); flex-wrap: wrap; justify-content: center; }
        .time-settings input { width: clamp(50px, 15vw, 70px); padding: clamp(6px, 1.5vw, 8px); font-size: inherit; text-align: center; background-color: transparent; border: 1px solid rgba(255, 255, 255, 0.2); color: inherit; border-radius: 6px; font-family: var(--font-family-en); }
        body.light-mode .time-settings input { border-color: rgba(0, 0, 0, 0.2); }
        body.timer-running-mode .time-settings { opacity: 0; visibility: hidden; pointer-events: none; max-height: 0; margin: 0; }

        /* --- ★音楽プレイヤー (タイマーの真下に配置) --- */
        .music-player-container {
            display: flex; flex-direction: column; align-items: center; justify-content: center;
            gap: 10px; width: 100%; max-width: 400px;
            z-index: 2;
            transition: opacity 0.4s, transform 0.4s;
            margin-top: auto; /* 上に余白を追加 */
        }
        .music-player-container.hidden { opacity: 0; transform: translateY(20px); pointer-events: none; height: 0; margin: 0; overflow: hidden; }
        .music-info { text-align: center; }
        .music-info .title { font-size: clamp(1rem, 3vw, 1.2rem); font-weight: 700; margin-bottom: 2px; }
        .music-info .subtitle { font-size: clamp(0.8rem, 2.5vw, 0.9rem); opacity: 0.7; }
        .player-controls { display: flex; gap: 20px; align-items: center; }
        /* ★アイコンサイズ修正 (スマホ対応) */
        .player-controls button { font-size: clamp(2rem, 7vw, 2.5rem); padding: 5px; }

        /* --- CDアニメーション --- */
        .cd-animation-container {
            position: fixed; bottom: -10vh; left: 50%;
            transform: translateX(-50%);
            width: clamp(200px, 50vw, 280px); height: clamp(200px, 50vw, 280px);
            opacity: 0; transition: opacity 0.5s ease-in-out;
            z-index: 0; display: flex; align-items: center; justify-content: center;
            pointer-events: none;
        }
        .cd-animation-container.show { opacity: 0.5; }
        .cd-disk { width: 100%; height: 100%; border-radius: 50%; background-color: #222; position: relative; overflow: hidden; box-shadow: 0 10px 30px rgba(0,0,0,0.3); transition: background-color 0.3s; }
        body.light-mode .cd-disk { background-color: #ccc; }
        .cd-disk::before { content: ''; position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); width: 25%; height: 25%; background-color: var(--bg-color-dark); border-radius: 50%; border: 2px solid rgba(255,255,255,0.05); transition: background-color 0.3s, border-color 0.3s; z-index: 2; }
        body.light-mode .cd-disk::before { background-color: var(--bg-color-light); border-color: rgba(0,0,0,0.05); }
        .cd-disk::after { content: ''; position: absolute; top: -50%; left: -50%; width: 200%; height: 200%; background: linear-gradient(to right, rgba(255,255,255,0) 0%, rgba(255,255,255,0.1) 48%, rgba(255,255,255,0) 52%); opacity: 0; transition: opacity 0.5s; z-index: 1; }
        .cd-disk.rotating { animation: cd-rotate 5s linear infinite; }
        .cd-disk.rotating::after { opacity: 1; animation: cd-shine 3s linear infinite; }
        @keyframes cd-rotate { from { transform: rotate(0deg); } to { transform: rotate(360deg); } }
        @keyframes cd-shine { from { transform: rotate(0deg); } to { transform: rotate(360deg); } }
        
        /* --- その他エフェクト --- */
        #rain-container { position: fixed; top: 0; left: 0; width: 100vw; height: 100vh; overflow: hidden; pointer-events: none; z-index: -1; opacity: 0; transition: opacity 0.5s ease-in-out; }
        #rain-container.show { opacity: 0.6; }
        .raindrop { position: absolute; background-color: rgba(173, 216, 230, 0.8); width: 1px; height: 10px; opacity: 0; animation: rain-fall linear infinite; }
        body.light-mode .raindrop { background-color: rgba(0, 0, 0, 0.8); }
        @keyframes rain-fall { 0% { transform: translateY(-100px); opacity: 0; } 10% { opacity: 1; } 100% { transform: translateY(110vh); opacity: 0; } }
        
        .notification-banner { position: fixed; top: 20px; right: 20px; background: rgba(0, 0, 0, 0.9); color: white; padding: 12px 20px; border-radius: 8px; font-size: 0.9rem; opacity: 0; transform: translateX(100%); transition: all 0.3s ease; z-index: 1000; backdrop-filter: blur(10px); }
        .notification-banner.show { opacity: 1; transform: translateX(0); }
        body.light-mode .notification-banner { background: rgba(255, 255, 255, 0.9); color: black; }

        /* スマホ横向き時のレイアウト調整 */
        @media screen and (max-width: 768px) and (orientation: landscape) {
            body {
                grid-template-columns: 1fr 1fr; /* 2カラムにする */
                grid-template-rows: auto 1fr auto;
                grid-template-areas:
                    "top-left top-right"
                    "center center" /* タイマー部分は中央に */
                    "bottom-left bottom-right";
                padding: 10px; /* パディングを少し減らす */
            }

            #clock {
                justify-self: start;
                padding-left: 10px; /* 左寄せ */
            }

            .top-right-controls {
                justify-self: end;
                padding-right: 10px; /* 右寄せ */
            }

            .timer-container {
                height: auto; /* 高さを自動調整 */
                overflow-y: visible; /* スクロールを解除 */
                padding: 5px 0; /* パディングを調整 */
            }

            .timer-wrapper {
                flex-direction: row; /* 横並びにする */
                flex-wrap: wrap; /* 折り返す */
                justify-content: center;
                gap: 10px; /* Gapを調整 */
            }

            .timer-display-wrapper {
                flex-basis: 100%; /* タイマー表示は幅100% */
                padding: clamp(5px, 2vw, 8px) clamp(10px, 4vw, 20px); /* パディング調整 */
            }

            #timer-display {
                font-size: clamp(2.5rem, 8vw, 5rem); /* フォントサイズを調整 */
                height: auto; /* 高さを自動調整 */
            }

            .timer-controls {
                flex-basis: 100%; /* 操作ボタンも幅100% */
                justify-content: center;
                gap: clamp(8px, 2vw, 15px);
            }

            .timer-controls button {
                font-size: clamp(1.8rem, 6vw, 2.5rem); /* アイコンサイズを調整 */
            }

            .time-settings {
                flex-basis: 100%; /* 設定も幅100% */
                margin-top: 5px; /* マージンを調整 */
                font-size: clamp(0.7rem, 1.8vw, 0.85rem); /* フォントサイズを調整 */
            }

            .time-settings input {
                width: clamp(40px, 12vw, 60px); /* 入力欄の幅を調整 */
                padding: clamp(4px, 1vw, 6px); /* パディングを調整 */
            }

            .music-player-container {
                margin-top: 15px; /* マージンを調整 */
                flex-basis: 100%; /* 音楽プレイヤーも幅100% */
                max-width: 100%; /* 最大幅を解除 */
            }

            .player-controls button {
                font-size: clamp(1.8rem, 6vw, 2.2rem); /* 音楽プレイヤーアイコンサイズを調整 */
            }

            .bottom-left-controls, .bottom-right-controls {
                align-self: flex-end; /* 下に揃える */
                position: relative;
                padding-bottom: 5px; /* 下に少しパディング */
            }

            #menu-panel, #total-study-time-display {
                position: fixed; /* 固定位置にする */
                bottom: auto; /* autoに戻す */
                top: 50%; /* 画面中央に配置 */
                left: 50%;
                transform: translate(-50%, -50%); /* 中央寄せ */
                max-height: 90vh; /* 高さの最大値を調整 */
                width: 90vw; /* 幅を調整 */
                padding: 10px;
                border-radius: 10px;
                box-shadow: 0 4px 20px rgba(0,0,0,0.3);
            }

            #menu-panel.show, #total-study-time-display.show {
                transform: translate(-50%, -50%); /* 中央寄せを維持 */
                opacity: 1; visibility: visible;
            }

            .cd-animation-container {
                width: clamp(150px, 40vw, 250px); /* CDアニメーションのサイズ調整 */
                height: clamp(150px, 40vw, 250px);
                bottom: -5vh; /* 位置を少し上に */
            }
        }
    </style>
</head>
<body>
    <div id="splash-screen">
        <div class="splash-clock-wrapper">
            <div class="splash-clock">
                <div class="clock-hand hour-hand"></div>
                <div class="clock-hand minute-hand"></div>
            </div>
            <div class="splash-title">Focus Timer</div>
        </div>
    </div>

    <div id="clock"></div>

    <div class="top-right-controls">
        <button id="mode-toggle" title="モード切替"><i class="ri-sun-line"></i></button>
    </div>

    <div class="timer-container">
        <div class="timer-wrapper">
            <div class="timer-display-wrapper">
                <div id="timer-display"></div>
            </div>
            <div class="timer-controls">
                <button id="start-pause" title="開始/一時停止 (Space)"><i class="ri-play-circle-line"></i></button>
                <button id="reset" title="リセット (R)"><i class="ri-restart-line"></i></button>
            </div>
            <div class="time-settings">
                <div> <label for="study-time-input">集中</label> <input type="number" id="study-time-input" value="25" min="1"> <span>分</span> </div>
                <div> <label for="break-time-input">休憩</label> <input type="number" id="break-time-input" value="5" min="1"> <span>分</span> </div>
            </div>
            <div class="music-player-container hidden" id="music-player-container">
                <div class="music-info">
                    <div class="title" id="music-title"></div>
                    <div class="subtitle" id="music-artist"></div>
                </div>
                <div class="player-controls">
                    <button id="prev-track" title="前の曲 (,)"><i class="ri-skip-back-fill"></i></button>
                    <button id="play-pause-music" title="再生/停止 (M)"><i class="ri-play-fill"></i></button>
                    <button id="next-track" title="次の曲 (.)"><i class="ri-skip-forward-fill"></i></button>
                </div>
                <audio id="music-audio" loop></audio>
            </div>
        </div>
    </div>
    
    <div class="bottom-left-controls">
        <button id="menu-toggle" title="メニュー"><i class="ri-menu-line"></i></button>
        <div id="menu-panel">
            <div id="ambient-sounds-container"></div>
            <hr style="border-color: rgba(255,255,255,0.1); border-style: solid; margin: 5px 0;">
            <div class="menu-item">
                <div class="menu-label"><i class="ri-music-2-line"></i><label for="music-player-toggle">音楽</label></div>
                 <label class="switch"> <input type="checkbox" id="music-player-toggle"> <span class="slider"></span> </label>
            </div>
            <div class="menu-item">
                <div class="menu-label"><i class="ri-volume-up-line"></i><label>音楽音量</label></div>
                <div class="ambient-controls">
                    <input type="range" class="volume-slider" id="music-volume-slider" min="0" max="1" step="0.01" value="0.5">
                </div>
            </div>
        </div>
    </div>
    <div id="audio-container"></div>

    <div class="bottom-right-controls">
        <button id="total-study-time-toggle" title="今日の集中時間"><i class="ri-time-line"></i></button>
        <div id="total-study-time-display"></div>
    </div>

    <div class="notification-banner" id="notification-banner"></div>
    <div id="rain-container"></div>
    <div class="cd-animation-container" id="cd-animation-container">
        <div class="cd-disk" id="cd-disk"></div>
    </div>

    <script>
    document.addEventListener('DOMContentLoaded', () => {
        const getEl = (id) => document.getElementById(id);
        
        // データ定義
        const musicFiles = [ 'ふぁい - Night Glow.mp3' , 'ふぁい - Relaxing Moment.mp3' , 'ふぁい - Starry Night.mp3' , 'ふぁい - Twilight.mp3' ];
        const musicData = musicFiles.map(file => {
            const cleaned = file.replace('.mp3', ''), parts = cleaned.split(' - ');
            return { title: parts[1] || cleaned, artist: parts[0] || 'Unknown', src: `./sounds/musics/${file}` };
        });
        const ambientSounds = [
            { id: 'rain', name: '雨', icon: 'ri-rainy-line', src: './sounds/rain.mp3', animation: 'rain' },
            { id: 'fire', name: '焚き火', icon: 'ri-fire-line', src: './sounds/fire.mp3' },
            { id: 'wind', name: '風', icon: 'ri-windy-line', src: './sounds/wind.mp3' },
            { id: 'cafe', name: 'カフェ', icon: 'ri-cup-line', src: './sounds/cafe.mp3' },
        ];

        // 要素取得
        const splashScreen = getEl('splash-screen'), clockEl = getEl('clock'), modeToggleBtn = getEl('mode-toggle');
        const timerDisplay = getEl('timer-display'), startPauseBtn = getEl('start-pause'), resetBtn = getEl('reset');
        const studyTimeInput = getEl('study-time-input'), breakTimeInput = getEl('break-time-input');
        const totalToggleBtn = getEl('total-study-time-toggle'), totalDisplay = getEl('total-study-time-display');
        const menuToggleBtn = getEl('menu-toggle'), menuPanel = getEl('menu-panel');
        const musicPlayerToggle = getEl('music-player-toggle'), musicPlayerContainer = getEl('music-player-container');
        const musicAudio = getEl('music-audio'), musicTitle = getEl('music-title'), musicArtist = getEl('music-artist');
        const prevTrackBtn = getEl('prev-track'), playPauseMusicBtn = getEl('play-pause-music'), nextTrackBtn = getEl('next-track');
        const cdContainer = getEl('cd-animation-container'), cdDisk = getEl('cd-disk');
        const ambientContainer = getEl('ambient-sounds-container'), audioContainer = getEl('audio-container');
        const rainContainer = getEl('rain-container');
        const musicVolumeSlider = getEl('music-volume-slider'); // 音楽音量スライダーを追加

        // 状態変数
        let timerInterval, wakeLock, currentTrackIndex = 0, currentMode = 'study', totalSeconds = 0;
        let isTimerRunning = false, isMenuOpen = false, isMusicPlayerVisible = false, isPlayingMusic = false;
        let currentDayStudySeconds = 0, isTotalTimeVisible = false;
        const originalTitle = document.title;
        const audioElements = {};
        
        // --- 初期化処理 ---
        const init = () => {
            setTimeout(() => {
                splashScreen.style.transition = 'opacity 1s ease-out';
                splashScreen.style.opacity = '0';
                setTimeout(() => {
                    splashScreen.classList.add('hidden');
                }, 1000);
            }, 3500);
            
            setInterval(updateClock, 1000); updateClock();
            
            buildAmbientMenu();
            loadSettings(); // ambientSettings のロードをここで行う
            
            updateMusicInfo();
            checkAndResetDailyTotal();
            setupEventListeners();

            // 音楽プレイヤーが表示されていて、再生中の場合は、音楽を再生しフェードイン
            if (isMusicPlayerVisible && isPlayingMusic) {
                playPauseMusicBtn.innerHTML = '<i class="ri-pause-fill"></i>'; updateCdAnimation();
                fadeInAudio(musicAudio, parseFloat(musicVolumeSlider.value), 500).catch(() => { isPlayingMusic = false; updateCdAnimation(); });
            }

            // システムのテーマをチェックして初期モードを設定
            if (window.matchMedia('(prefers-color-scheme: light)').matches) {
                document.body.classList.add('light-mode');
                modeToggleBtn.innerHTML = '<i class="ri-moon-line"></i>';
            } else {
                document.body.classList.remove('light-mode');
                modeToggleBtn.innerHTML = '<i class="ri-sun-line"></i>';
            }

            // ★雨のトグルがオフの場合、雨のエフェクトを停止する
            const rainToggle = ambientContainer.querySelector(`.ambient-toggle[data-sound-id="rain"]`);
            if (rainToggle && !rainToggle.checked) {
                stopRainAnimation();
            }
        };

        const buildAmbientMenu = () => {
            ambientSounds.forEach(sound => {
                const audio = document.createElement('audio');
                audio.id = `audio-${sound.id}`; audio.src = sound.src; audio.loop = true;
                audioContainer.appendChild(audio);
                audioElements[sound.id] = audio;

                const item = document.createElement('div');
                item.className = 'ambient-item';
                item.innerHTML = `
                    <div class="menu-label"><i class="${sound.icon}"></i><label>${sound.name}</label></div>
                    <div class="ambient-controls">
                        <input type="range" class="volume-slider" data-sound-id="${sound.id}" min="0" max="1" step="0.01" value="0.5">
                        <label class="switch">
                            <input type="checkbox" class="ambient-toggle" data-sound-id="${sound.id}">
                            <span class="slider"></span>
                        </label>
                    </div>`;
                ambientContainer.appendChild(item);
            });
        };
        
        // --- 設定の保存・読込 ---
        const saveSettings = () => {
            const ambientSettings = {};
            ambientSounds.forEach(sound => {
                const toggle = ambientContainer.querySelector(`.ambient-toggle[data-sound-id="${sound.id}"]`);
                const slider = ambientContainer.querySelector(`.volume-slider[data-sound-id="${sound.id}"]`);
                ambientSettings[sound.id] = { enabled: toggle.checked, volume: parseFloat(slider.value) };
            });
            localStorage.setItem('focusTimer', JSON.stringify({
                studyTime: parseInt(studyTimeInput.value),
                breakTime: parseInt(breakTimeInput.value),
                lightMode: document.body.classList.contains('light-mode'),
                ambientSettings,
                currentTrackIndex,
                isPlayingMusic,
                isMusicPlayerVisible,
                musicVolume: parseFloat(musicVolumeSlider.value), // 音楽音量を保存
                isTimerRunning,
                currentMode,
                totalSeconds,
            }));
            saveTotalStudyTime();
        };
        const loadSettings = () => {
            const settings = JSON.parse(localStorage.getItem('focusTimer') || '{}');
            studyTimeInput.value = settings.studyTime || 25;
            breakTimeInput.value = settings.breakTime || 5;

            if (settings.lightMode !== undefined) {
                if (settings.lightMode) {
                    document.body.classList.add('light-mode');
                    modeToggleBtn.innerHTML = '<i class="ri-moon-line"></i>';
                } else {
                    document.body.classList.remove('light-mode');
                    modeToggleBtn.innerHTML = '<i class="ri-sun-line"></i>';
                }
            } else {
                if (window.matchMedia('(prefers-color-scheme: light)').matches) {
                    document.body.classList.add('light-mode');
                    modeToggleBtn.innerHTML = '<i class="ri-moon-line"></i>';
                } else {
                    document.body.classList.remove('light-mode');
                    modeToggleBtn.innerHTML = '<i class="ri-sun-line"></i>';
                }
            }

            const ambientSettings = settings.ambientSettings || {};
            ambientSounds.forEach(sound => {
                const config = ambientSettings[sound.id] || { enabled: false, volume: 0.5 };
                const toggle = ambientContainer.querySelector(`.ambient-toggle[data-sound-id="${sound.id}"]`);
                const slider = ambientContainer.querySelector(`.volume-slider[data-sound-id="${sound.id}"]`);
                toggle.checked = config.enabled; slider.value = config.volume;
                audioElements[sound.id].volume = config.volume; // 初期音量を設定
                if(config.enabled) {
                    fadeInAudio(audioElements[sound.id], config.volume, 1000).catch(()=>{}); // フェードインで再生
                    if(sound.animation === 'rain') startRainAnimation();
                } else { // ★雨のトグルがオフの場合、雨のエフェクトを停止する
                    if(sound.animation === 'rain') stopRainAnimation();
                }
            });
            
            currentTrackIndex = settings.currentTrackIndex || 0;
            isPlayingMusic = settings.isPlayingMusic || false;
            isMusicPlayerVisible = settings.isMusicPlayerVisible || false;
            musicPlayerToggle.checked = isMusicPlayerVisible;
            updateMusicPlayerVisibility();

            musicVolumeSlider.value = settings.musicVolume !== undefined ? settings.musicVolume : 0.5; // 音楽音量を読み込み
            musicAudio.volume = parseFloat(musicVolumeSlider.value); // 音楽オーディオの音量を設定

            loadTotalStudyTime();

            currentMode = settings.currentMode || 'study';
            totalSeconds = settings.totalSeconds !== undefined ? settings.totalSeconds : parseInt(studyTimeInput.value) * 60;
            isTimerRunning = settings.isTimerRunning || false;
            
            createDigitStructure(`${String(Math.floor(totalSeconds / 60)).padStart(2, '0')}:${String(totalSeconds % 60).padStart(2, '0')}`);
            updateTimerDisplay();
            timerDisplay.classList.toggle('resting', currentMode === 'break');
            updateUIForTimerState();
            if (isTimerRunning) {
                startTimer();
            }
        };

        // --- イベントリスナー設定 ---
        const setupEventListeners = () => {
            startPauseBtn.addEventListener('click', () => isTimerRunning ? pauseTimer() : startTimer());
            resetBtn.addEventListener('click', () => resetTimer(true));
            [studyTimeInput, breakTimeInput].forEach(input => input.addEventListener('change', () => {
                if (!isTimerRunning) {
                    resetTimer(false);
                }
                saveSettings();
            }));
            modeToggleBtn.addEventListener('click', () => {
                document.body.classList.toggle('light-mode');
                modeToggleBtn.innerHTML = document.body.classList.contains('light-mode') ? '<i class="ri-moon-line"></i>' : '<i class="ri-sun-line"></i>';
                saveSettings();
            });
            menuToggleBtn.addEventListener('click', toggleMenu);
            document.addEventListener('click', e => { if (isMenuOpen && !menuToggleBtn.parentElement.contains(e.target) && !menuPanel.contains(e.target)) toggleMenu(); });
            musicPlayerToggle.addEventListener('change', () => {
                isMusicPlayerVisible = musicPlayerToggle.checked;
                updateMusicPlayerVisibility();
                saveSettings();
            });
            totalToggleBtn.addEventListener('click', toggleTotalTimeDisplay);
            [prevTrackBtn, playPauseMusicBtn, nextTrackBtn].forEach(btn => btn.addEventListener('click', handleMusicControl));
            musicAudio.addEventListener('ended', () => playTrack(1));
            window.addEventListener('beforeunload', () => { releaseWakeLock(); saveSettings(); });
            document.addEventListener('keydown', handleKeyDown);
            ambientContainer.addEventListener('input', handleAmbientControl);
            ambientContainer.addEventListener('change', handleAmbientControl);
            musicVolumeSlider.addEventListener('input', () => { // 音楽音量スライダーのイベントリスナー
                musicAudio.volume = parseFloat(musicVolumeSlider.value);
                saveSettings();
            });
        };

        const handleAmbientControl = (e) => {
            const target = e.target;
            const soundId = target.dataset.soundId;
            if (!soundId) return;

            const audio = audioElements[soundId];
            if (target.classList.contains('volume-slider')) {
                audio.volume = parseFloat(target.value);
            }
            if (target.classList.contains('ambient-toggle')) {
                if (target.checked) {
                    fadeInAudio(audio, parseFloat(ambientContainer.querySelector(`.volume-slider[data-sound-id="${soundId}"]`).value), 1000); // 環境音は1秒でフェードイン
                    if(soundId === 'rain') startRainAnimation();
                } else {
                    // ★雨の音がオフになったらすぐに雨のエフェクトもオフにする
                    if(soundId === 'rain') {
                        fadeOutAudio(audio, 100, () => { // フェードアウト時間を短くしてすぐに停止
                            stopRainAnimation();
                        });
                    } else {
                        fadeOutAudio(audio, 1000); // その他の環境音はそのまま
                    }
                }
            }
            saveSettings();
        };

        const handleMusicControl = (e) => {
            const id = e.currentTarget.id;
            if (id === 'prev-track') playTrack(-1);
            else if (id === 'next-track') playTrack(1);
            else if (id === 'play-pause-music') toggleMusicPlay();
            saveSettings();
        };

        // --- UI/機能ハンドラ ---
        const updateClock = () => { clockEl.textContent = new Date().toLocaleTimeString('ja-JP', { hour: '2-digit', minute: '2-digit' }); };
        const toggleMenu = () => { isMenuOpen = !isMenuOpen; menuPanel.classList.toggle('show', isMenuOpen); };

        // タイマー
        const startTimer = () => {
            if (isTimerRunning) return;
            isTimerRunning = true;
            updateUIForTimerState();
            requestWakeLock();
            timerInterval = setInterval(runTimer, 1000);
            saveSettings();
        };
        const pauseTimer = () => {
            clearInterval(timerInterval);
            isTimerRunning = false;
            releaseWakeLock();
            updateUIForTimerState();
            saveSettings();
        };
        const resetTimer = (animate = true) => {
            pauseTimer();
            currentMode = 'study';
            totalSeconds = parseInt(studyTimeInput.value) * 60 || 0;
            createDigitStructure(`${String(Math.floor(totalSeconds / 60)).padStart(2, '0')}:00`);
            updateTimerDisplay();
            timerDisplay.classList.remove('resting');
            saveSettings();
        };
        const runTimer = () => {
            totalSeconds--;
            updateTimerDisplay();
            if (currentMode === 'study') { currentDayStudySeconds++; if (isTotalTimeVisible) updateTotalStudyTimeDisplay(); }
            if (totalSeconds <= 0) {
                clearInterval(timerInterval);
                isTimerRunning = false;
                setTimeout(() => playBeep(600, 800), 200);
                switchMode();
            }
            saveSettings();
        };
        const switchMode = () => {
            saveSettings();
            currentMode = currentMode === 'study' ? 'break' : 'study';
            totalSeconds = parseInt(currentMode === 'study' ? studyTimeInput.value : breakTimeInput.value) * 60 || 0;
            createDigitStructure(`${String(Math.floor(totalSeconds / 60)).padStart(2, '0')}:00`);
            timerDisplay.classList.toggle('resting', currentMode === 'break');
            startTimer();
        };
        const updateUIForTimerState = () => { document.body.classList.toggle('timer-running-mode', isTimerRunning); startPauseBtn.innerHTML = isTimerRunning ? '<i class="ri-pause-circle-line"></i>' : '<i class="ri-play-circle-line"></i>'; };
        const createDigitStructure = (initialString) => { timerDisplay.innerHTML = ''; for (const char of initialString) { if (char === ':') { timerDisplay.insertAdjacentHTML('beforeend', '<span class="colon">:</span>'); continue; } const d = document.createElement('div'); d.className = 'digit-container'; const s = document.createElement('div'); s.className = 'digit-strip'; for (let i = 0; i <= 9; i++) s.insertAdjacentHTML('beforeend', `<div>${i}</div>`); d.append(s); timerDisplay.append(d); const n = parseInt(char); if (!isNaN(n)) s.style.transform = `translateY(calc(-1 * (1 + ${n}) * var(--digit-height)))`; } };
        const updateTimerDisplay = () => { const m = Math.floor(totalSeconds / 60), s = totalSeconds % 60, str = `${String(m).padStart(2, '0')}:${String(s).padStart(2, '0')}`; document.title = `${str} - ${originalTitle}`; const strips = timerDisplay.querySelectorAll('.digit-strip'); let i = 0; for (const char of str.replace(':', '')) { if (strips[i]) strips[i].style.transform = `translateY(calc(-1 * (1 + ${char}) * var(--digit-height)))`; i++; } };

        // 集中時間
        const checkAndResetDailyTotal = () => { const todayKey = `focusDate_${new Date().toISOString().slice(0, 10)}`; if (localStorage.getItem('lastAccessDate') !== todayKey) { currentDayStudySeconds = 0; saveTotalStudyTime(); localStorage.setItem('lastAccessDate', todayKey); } updateTotalStudyTimeDisplay(); };
        const loadTotalStudyTime = () => { currentDayStudySeconds = parseInt(localStorage.getItem(`totalStudy_${new Date().toISOString().slice(0, 10)}`) || '0'); };
        const saveTotalStudyTime = () => localStorage.setItem(`totalStudy_${new Date().toISOString().slice(0, 10)}`, currentDayStudySeconds);
        const toggleTotalTimeDisplay = () => { isTotalTimeVisible = !isTotalTimeVisible; totalDisplay.classList.toggle('show', isTotalTimeVisible); if(isTotalTimeVisible) updateTotalStudyTimeDisplay(); };
        const updateTotalStudyTimeDisplay = () => { const h = Math.floor(currentDayStudySeconds / 3600), m = Math.floor((currentDayStudySeconds % 3600) / 60), s = currentDayStudySeconds % 60; let str = (h > 0) ? `${h}時間${m}分` : (m > 0) ? `${m}分${s}秒` : `${s}秒`; if(currentDayStudySeconds === 0) str = '0秒'; totalDisplay.textContent = `今日の集中: ${str}`; };
        
        // 音楽プレイヤー
        const updateMusicPlayerVisibility = () => { musicPlayerContainer.classList.toggle('hidden', !isMusicPlayerVisible); if (!isMusicPlayerVisible && isPlayingMusic) toggleMusicPlay(); updateCdAnimation(); };
        const updateCdAnimation = () => { const shouldShow = isMusicPlayerVisible && isPlayingMusic; cdContainer.classList.toggle('show', shouldShow); cdDisk.classList.toggle('rotating', shouldShow); };
        const updateMusicInfo = () => { if (!musicData.length) return; const { title, artist, src } = musicData[currentTrackIndex]; musicTitle.textContent = title; musicArtist.textContent = artist; musicAudio.src = src; };
        const toggleMusicPlay = () => {
            isPlayingMusic = !isPlayingMusic;
            if (isPlayingMusic) {
                fadeInAudio(musicAudio, parseFloat(musicVolumeSlider.value), 500); // 音楽は0.5秒でフェードイン
            } else {
                fadeOutAudio(musicAudio, 500); // 音楽は0.5秒でフェードアウト
            }
            playPauseMusicBtn.innerHTML = isPlayingMusic ? '<i class="ri-pause-fill"></i>' : '<i class="ri-play-fill"></i>';
            updateCdAnimation();
            saveSettings();
        };
        const playTrack = (dir) => {
            if (!musicData.length) return;
            currentTrackIndex = (currentTrackIndex + dir + musicData.length) % musicData.length;
            updateMusicInfo();
            if (isPlayingMusic) fadeInAudio(musicAudio, parseFloat(musicVolumeSlider.value), 500); // 曲変更時もフェードイン
            saveSettings();
        };

        // フェードイン/アウト関数
        const fadeInAudio = (audio, targetVolume, duration) => {
            audio.play().catch(()=>{}); // まず再生を試みる
            audio.volume = 0; // 初期音量を0に設定
            let startTime = null;
            const animate = (currentTime) => {
                if (!startTime) startTime = currentTime;
                const progress = (currentTime - startTime) / duration;
                audio.volume = Math.min(targetVolume, targetVolume * progress);
                if (progress < 1 && audio.volume < targetVolume) {
                    requestAnimationFrame(animate);
                } else {
                    audio.volume = targetVolume; // 最終的に目標音量に設定
                }
            };
            return new Promise(resolve => requestAnimationFrame(animate));
        };

        const fadeOutAudio = (audio, duration, callback = () => {}) => {
            const initialVolume = audio.volume;
            let startTime = null;
            const animate = (currentTime) => {
                if (!startTime) startTime = currentTime;
                const progress = (currentTime - startTime) / duration;
                audio.volume = initialVolume * (1 - progress);
                if (progress < 1 && audio.volume > 0) {
                    requestAnimationFrame(animate);
                } else {
                    audio.volume = 0;
                    audio.pause();
                    callback();
                }
            };
            requestAnimationFrame(animate);
        };
        
        // その他
        const handleKeyDown = (e) => { if (e.target.tagName === 'INPUT') return; const keyMap = { Space: () => startPauseBtn.click(), KeyR: () => resetBtn.click(), KeyM: () => isMusicPlayerVisible && playPauseMusicBtn.click(), Comma: () => isMusicPlayerVisible && prevTrackBtn.click(), Period: () => isMusicPlayerVisible && nextTrackBtn.click() }; if (keyMap[e.code]) { e.preventDefault(); keyMap[e.code](); } };
        const playBeep = (freq, dur) => { const ctx = new (window.AudioContext || window.webkitAudioContext)(); if (!ctx) return; const o = ctx.createOscillator(), g = ctx.createGain(); o.connect(g); g.connect(ctx.destination); o.frequency.value = freq; g.gain.setValueAtTime(0.3, ctx.currentTime); g.gain.exponentialRampToValueAtTime(0.01, ctx.currentTime + dur / 1000); o.start(); o.stop(ctx.currentTime + dur / 1000); };
        const requestWakeLock = async () => { if ('wakeLock' in navigator) try { wakeLock = await navigator.wakeLock.request('screen'); } catch (err) {} };
        const releaseWakeLock = () => wakeLock?.release().then(() => wakeLock = null);
        let rainAnimationInterval;
        const createRaindrop = () => { const d = document.createElement('div'); d.className = 'raindrop'; d.style.left = `${Math.random()*100}vw`; d.style.animationDuration = `${Math.random()*0.8+0.7}s`; rainContainer.append(d); if(rainContainer.children.length > 100) rainContainer.firstChild.remove(); };
        const startRainAnimation = () => { if(rainAnimationInterval) return; rainContainer.classList.add('show'); rainAnimationInterval = setInterval(createRaindrop, 100); };
        const stopRainAnimation = () => { clearInterval(rainAnimationInterval); rainAnimationInterval = null; rainContainer.classList.remove('show'); rainContainer.innerHTML = ''; };

        init();
    });
    </script>
</body>
</html>
